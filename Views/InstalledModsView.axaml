<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Yellowcake.ViewModels"
             xmlns:models="using:Yellowcake.Models"
             x:Class="Yellowcake.Views.InstalledModsView"
             x:DataType="vm:MainViewModel">
  
  <Panel Margin="0">
    <ListBox ItemsSource="{Binding InstalledMods}"
             SelectedItem="{Binding SelectedMod}"
             Background="Transparent"
             BorderThickness="0"
             Padding="5,10"
             Margin="5,0,5,5"
             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
      
      <ListBox.Styles>
        <Style Selector="ListBoxItem">
          <Setter Property="Background" Value="Transparent"/>
          <Setter Property="Padding" Value="0,0,0,0"/>
          <Setter Property="Template">
            <ControlTemplate>
              <ContentPresenter Content="{TemplateBinding Content}"
                                ContentTemplate="{TemplateBinding ContentTemplate}"/>
            </ControlTemplate>
          </Setter>
        </Style>
      </ListBox.Styles>

      <ListBox.ContextMenu>
        <ContextMenu>
          <MenuItem Header="Enable/Disable" Command="{Binding ToggleModCommand}" CommandParameter="{Binding SelectedMod}"/>
          <MenuItem Header="Update" Command="{Binding UpdateModCommand}" CommandParameter="{Binding SelectedMod}" IsVisible="{Binding SelectedMod.HasUpdate}"/>
          <MenuItem Header="Uninstall" Command="{Binding UninstallModCommand}" CommandParameter="{Binding SelectedMod}"/>
          <Separator/>
          <MenuItem Header="Open Folder" Command="{Binding OpenModFolderCommand}" CommandParameter="{Binding SelectedMod}"/>
          <MenuItem Header="View Details" Command="{Binding OpenDetailsCommand}" CommandParameter="{Binding SelectedMod}"/>
          <Separator/>
          <MenuItem Header="Verify Integrity" Command="{Binding VerifyModCommand}" CommandParameter="{Binding SelectedMod}"/>
          <MenuItem Header="Reinstall" Command="{Binding ReinstallModCommand}" CommandParameter="{Binding SelectedMod}"/>
        </ContextMenu>
      </ListBox.ContextMenu>

      <ListBox.ItemTemplate>
        <DataTemplate x:DataType="models:Mod">
          <Border Background="{DynamicResource CardBackgroundBrush}"
                  Padding="20,16"
                  Margin="0,6"
                  CornerRadius="12"
                  BorderBrush="{DynamicResource BorderBrush}"
                  BorderThickness="1"
                  Opacity="{Binding IsEnabled, Converter={StaticResource EnabledToOpacityConverter}}">
            
            <Border.Transitions>
              <Transitions>
                <BrushTransition Property="BorderBrush" Duration="0:0:0.2"/>
                <DoubleTransition Property="Opacity" Duration="0:0:0.2"/>
              </Transitions>
            </Border.Transitions>

            <Border.Styles>
              <Style Selector="Border:pointerover">
                <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentBrush}"/>
              </Style>
            </Border.Styles>

            <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto">
              
              <!-- Checkbox -->
              <CheckBox Grid.Column="0" 
                        IsChecked="{Binding IsEnabled}" 
                        Margin="0,0,12,0"
                        VerticalAlignment="Center"
                        Command="{Binding $parent[ListBox].((vm:MainViewModel)DataContext).ToggleModCommand}"
                        CommandParameter="{Binding}"/>

              <!-- Icon -->
              <Border Grid.Column="1" 
                      Width="48" 
                      Height="48" 
                      CornerRadius="8" 
                      ClipToBounds="True" 
                      Margin="0,0,12,0"
                      Background="{DynamicResource SystemAccentBrushLight}">
                <Panel>
                  <Image Source="{Binding PreviewImageUrl}" 
                         Stretch="UniformToFill" 
                         IsVisible="{Binding PreviewImageUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                  <PathIcon Data="{StaticResource BoxIcon}" 
                            Width="24" 
                            Height="24" 
                            Foreground="{DynamicResource SystemAccentBrush}"
                            IsVisible="{Binding PreviewImageUrl, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>
                </Panel>
              </Border>

              <!-- Info -->
              <StackPanel Grid.Column="2" 
                          VerticalAlignment="Center"
                          Spacing="4">
                <StackPanel Orientation="Horizontal" Spacing="12">
                  <TextBlock Text="{Binding Name}" 
                             FontWeight="SemiBold" 
                             FontSize="14"/>
                  <Border Background="{DynamicResource SystemAccentBrushLight}" 
                          BorderBrush="{DynamicResource SystemAccentBrush}"
                          BorderThickness="1"
                          CornerRadius="4" 
                          Padding="6,2" 
                          VerticalAlignment="Center">
                    <TextBlock Text="{Binding Category}" 
                               FontSize="10" 
                               FontWeight="Bold" 
                               Foreground="{DynamicResource SystemAccentBrush}"/>
                  </Border>
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <TextBlock Text="{Binding Version, StringFormat='v{0}'}" 
                             FontSize="11" 
                             Opacity="0.7"/>
                  <TextBlock Text="â€¢" 
                             FontSize="11" 
                             Opacity="0.5"/>
                  <TextBlock Text="{Binding IsEnabled, Converter={StaticResource BoolToEnabledTextConverter}}" 
                             FontSize="11" 
                             Opacity="0.7"/>
                </StackPanel>
              </StackPanel>

              <!-- Update Badge -->
              <Border Grid.Column="3" 
                      Background="#FF4CAF50" 
                      CornerRadius="12" 
                      Padding="8,4" 
                      Margin="0,0,8,0" 
                      VerticalAlignment="Center"
                      IsVisible="{Binding HasUpdate}">
                <TextBlock Text="Update Available" 
                           FontSize="10" 
                           Foreground="White"
                           FontWeight="Bold"/>
              </Border>

              <!-- Actions -->
              <StackPanel Grid.Column="4" 
                          Orientation="Horizontal" 
                          Spacing="4"
                          VerticalAlignment="Center">
                <Button Classes="Icon" 
                        ToolTip.Tip="View Details"
                        Command="{Binding $parent[ListBox].((vm:MainViewModel)DataContext).OpenDetailsCommand}"
                        CommandParameter="{Binding}"
                        Width="36"
                        Height="36">
                  <PathIcon Data="{StaticResource InfoIcon}" 
                            Width="16" 
                            Height="16"/>
                </Button>
                
                <Button Classes="Icon" 
                        ToolTip.Tip="Update"
                        Command="{Binding $parent[ListBox].((vm:MainViewModel)DataContext).UpdateModCommand}"
                        CommandParameter="{Binding}"
                        Width="36"
                        Height="36"
                        IsVisible="{Binding HasUpdate}">
                  <PathIcon Data="{StaticResource RefreshIcon}" 
                            Width="16" 
                            Height="16"/>
                </Button>
                
                <Button Classes="Icon" 
                        ToolTip.Tip="Uninstall"
                        Command="{Binding $parent[ListBox].((vm:MainViewModel)DataContext).UninstallModCommand}"
                        CommandParameter="{Binding}"
                        Width="36"
                        Height="36">
                  <PathIcon Data="{StaticResource DeleteIcon}" 
                            Width="16" 
                            Height="16"
                            Foreground="#FF6B6B"/>
                </Button>
              </StackPanel>
            </Grid>
          </Border>
        </DataTemplate>
      </ListBox.ItemTemplate>
    </ListBox>

    <!-- Empty State -->
    <StackPanel HorizontalAlignment="Center" 
                VerticalAlignment="Center"
                Spacing="16"
                IsVisible="{Binding !InstalledMods.Count}">
      <PathIcon Data="{StaticResource BoxIcon}" 
                Width="64" 
                Height="64" 
                Foreground="{DynamicResource SubTextBrush}"
                Opacity="0.3"/>
      <TextBlock Text="No mods installed yet" 
                 FontSize="16" 
                 FontWeight="SemiBold"
                 Foreground="{DynamicResource SubTextBrush}"
                 HorizontalAlignment="Center"/>
      <TextBlock Text="Visit the Browse tab to install mods" 
                 FontSize="13"
                 Foreground="{DynamicResource SubTextBrush}"
                 Opacity="0.7"
                 HorizontalAlignment="Center"/>
    </StackPanel>
  </Panel>
</UserControl>