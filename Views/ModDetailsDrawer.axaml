<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Yellowcake.ViewModels"
             xmlns:models="using:Yellowcake.Models"
             x:Class="Yellowcake.Views.ModDetailsDrawer"
             x:DataType="vm:MainViewModel"
             Width="420"
             Background="{DynamicResource CardBackgroundBrush}"
             BorderBrush="{DynamicResource BorderBrush}"
             BorderThickness="1,0,0,0"
             IsVisible="{Binding IsDetailsOpen}">

  <Panel IsVisible="{Binding DetailsMod, Converter={x:Static ObjectConverters.IsNotNull}}">
    <Panel DataContext="{Binding DetailsMod}">
      <Grid RowDefinitions="Auto, *">
        
        <!-- Header -->
        <Border Grid.Row="0" 
                Background="{DynamicResource SystemAccentBrushLight}" 
                Padding="20,16" 
                BorderBrush="{DynamicResource SystemAccentBrush}" 
                BorderThickness="0,0,0,2">
          <Grid ColumnDefinitions="*, Auto">
            <StackPanel>
              <TextBlock Text="{Binding Name, FallbackValue='Loading...'}" 
                         FontSize="20" 
                         FontWeight="Bold"
                         TextWrapping="Wrap"/>
              <TextBlock Text="{Binding Version, StringFormat='Version {0}', FallbackValue='...'}" 
                         FontSize="12" 
                         Opacity="0.8" 
                         Margin="0,4,0,0"/>
            </StackPanel>
            
            <Button Grid.Column="1" 
                    Classes="Icon" 
                    Command="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).CloseModDetailsCommand}" 
                    ToolTip.Tip="Close details (Esc)" 
                    Width="36" 
                    Height="36">
              <PathIcon Data="{StaticResource CloseIcon}" Width="14" Height="14"/>
            </Button>
          </Grid>
        </Border>

        <!-- Content -->
        <ScrollViewer Grid.Row="1" 
                      Padding="20"
                      VerticalScrollBarVisibility="Auto">
          <StackPanel Spacing="24">
            
            <!-- Preview Image -->
            <StackPanel Spacing="8" IsVisible="{Binding HasThumbnail, FallbackValue=False}">
              <TextBlock Text="PREVIEW" 
                         FontSize="11" 
                         FontWeight="Black" 
                         Opacity="0.5" 
                         LetterSpacing="1"/>
              <Border CornerRadius="8" 
                      ClipToBounds="True" 
                      MaxHeight="240">
                <Image Source="{Binding ThumbnailUrl}" 
                       Stretch="UniformToFill"/>
              </Border>
            </StackPanel>

            <!-- Description -->
            <StackPanel Spacing="8">
              <TextBlock Text="DESCRIPTION" 
                         FontSize="11" 
                         FontWeight="Black" 
                         Opacity="0.5" 
                         LetterSpacing="1"/>
              <TextBlock Text="{Binding Description, FallbackValue='No description available'}" 
                         TextWrapping="Wrap" 
                         FontSize="13" 
                         LineHeight="22"/>
            </StackPanel>

            <!-- Information -->
            <StackPanel Spacing="8">
              <TextBlock Text="INFORMATION" 
                         FontSize="11" 
                         FontWeight="Black" 
                         Opacity="0.5" 
                         LetterSpacing="1"/>
              <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" 
                    ColumnDefinitions="120,*">
                
                <TextBlock Grid.Row="0" Grid.Column="0" 
                           Text="Category" 
                           FontWeight="SemiBold" 
                           FontSize="12"/>
                <TextBlock Grid.Row="0" Grid.Column="1" 
                           Text="{Binding Category, FallbackValue='Unknown'}" 
                           FontSize="12" 
                           Opacity="0.8"/>
                
                <TextBlock Grid.Row="1" Grid.Column="0" 
                           Text="Authors" 
                           FontWeight="SemiBold" 
                           FontSize="12" 
                           Margin="0,8,0,0"/>
                <ItemsControl Grid.Row="1" Grid.Column="1" 
                              ItemsSource="{Binding Authors}" 
                              Margin="0,8,0,0">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <StackPanel Orientation="Vertical" Spacing="4"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding}" 
                                 FontSize="12" 
                                 Opacity="0.8"/>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <TextBlock Grid.Row="2" Grid.Column="0" 
                           Text="Download Size" 
                           FontWeight="SemiBold" 
                           FontSize="12" 
                           Margin="0,8,0,0"/>
                <TextBlock Grid.Row="2" Grid.Column="1" 
                           Text="{Binding FileSizeFormatted, FallbackValue='Unknown'}" 
                           FontSize="12" 
                           Opacity="0.8" 
                           Margin="0,8,0,0"/>
                
                <TextBlock Grid.Row="3" Grid.Column="0" 
                           Text="Status" 
                           FontWeight="SemiBold" 
                           FontSize="12" 
                           Margin="0,8,0,0"/>
                <TextBlock Grid.Row="3" Grid.Column="1" 
                           Text="{Binding IsInstalled, Converter={StaticResource BoolToInstalledTextConverter}, FallbackValue='Not Installed'}" 
                           FontSize="12" 
                           Opacity="0.8" 
                           Margin="0,8,0,0"/>
                
                <TextBlock Grid.Row="4" Grid.Column="0" 
                           Text="Source" 
                           FontWeight="SemiBold" 
                           FontSize="12" 
                           Margin="0,8,0,0"/>
                <TextBlock Grid.Row="4" Grid.Column="1" 
                           Text="{Binding Source, FallbackValue='Remote'}" 
                           FontSize="12" 
                           Opacity="0.8" 
                           Margin="0,8,0,0"/>
              </Grid>
            </StackPanel>

            <!-- Changelog -->
            <StackPanel Spacing="8" IsVisible="{Binding HasUpdate, FallbackValue=False}">
              <TextBlock Text="CHANGELOG" 
                         FontSize="11" 
                         FontWeight="Black" 
                         Opacity="0.5" 
                         LetterSpacing="1"/>
              <Border Background="#0A000000" 
                      CornerRadius="8" 
                      Padding="12">
                <TextBlock Text="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).ModChangelog, FallbackValue='No changelog available'}" 
                           TextWrapping="Wrap" 
                           FontSize="12" 
                           FontFamily="Consolas" 
                           LineHeight="18"/>
              </Border>
            </StackPanel>

            <!-- Dependencies -->
            <StackPanel Spacing="8" IsVisible="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).ModDependencies.Count, Converter={StaticResource GreaterThanZeroConverter}, FallbackValue=False}">
              <TextBlock Text="DEPENDENCIES" 
                         FontSize="11" 
                         FontWeight="Black" 
                         Opacity="0.5" 
                         LetterSpacing="1"/>
              <ItemsControl ItemsSource="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).ModDependencies}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="models:Mod">
                    <Border Background="#0AFFFFFF" 
                            CornerRadius="6" 
                            Padding="10" 
                            Margin="0,0,0,6">
                      <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="{Binding Name}" 
                                   FontSize="13" 
                                   FontWeight="Medium"/>
                        <TextBlock Grid.Column="1" 
                                   Text="{Binding IsInstalled, Converter={StaticResource BoolToStatusTextConverter}}" 
                                   FontSize="11" 
                                   Foreground="{DynamicResource SystemAccentBrush}"/>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>

            <!-- Conflicts -->
            <StackPanel Spacing="8" IsVisible="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).ModConflicts.Count, Converter={StaticResource GreaterThanZeroConverter}, FallbackValue=False}">
              <TextBlock Text="⚠ POTENTIAL CONFLICTS" 
                         FontSize="11" 
                         FontWeight="Black" 
                         Opacity="0.5" 
                         LetterSpacing="1" 
                         Foreground="#FFFF9800"/>
              <ItemsControl ItemsSource="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).ModConflicts}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="models:Mod">
                    <Border Background="#15FF9800" 
                            BorderBrush="#FFFF9800" 
                            BorderThickness="1" 
                            CornerRadius="6" 
                            Padding="10" 
                            Margin="0,0,0,6">
                      <TextBlock Text="{Binding Name}" 
                                 FontSize="13" 
                                 FontWeight="Medium"/>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>

            <!-- Actions -->
            <StackPanel Spacing="12">
              <Button Command="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).DownloadModCommand}" 
                      CommandParameter="{Binding}"
                      Classes="Filled"
                      HorizontalAlignment="Stretch"
                      Height="44"
                      IsVisible="{Binding !IsInstalled, FallbackValue=True}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <PathIcon Data="{StaticResource ArrowBottomIcon}" Width="16" Height="16"/>
                  <TextBlock Text="INSTALL MOD" FontWeight="Bold"/>
                </StackPanel>
              </Button>

              <Button Command="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).DeleteModCommand}" 
                      CommandParameter="{Binding}"
                      Classes="Tonal"
                      HorizontalAlignment="Stretch"
                      Height="44"
                      Foreground="#FF6B6B"
                      IsVisible="{Binding IsInstalled, FallbackValue=False}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <PathIcon Data="{StaticResource DeleteIcon}" Width="16" Height="16"/>
                  <TextBlock Text="UNINSTALL MOD" FontWeight="Bold"/>
                </StackPanel>
              </Button>

              <Button Command="{Binding $parent[UserControl].((vm:MainViewModel)DataContext).OpenUrlCommand}" 
                      CommandParameter="{Binding InfoUrl}"
                      Classes="Tonal"
                      HorizontalAlignment="Stretch"
                      Height="44"
                      IsVisible="{Binding InfoUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}, FallbackValue=False}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <PathIcon Data="{StaticResource BoxIcon}" Width="16" Height="16"/>
                  <TextBlock Text="OPEN PROJECT PAGE" FontWeight="Bold"/>
                </StackPanel>
              </Button>
            </StackPanel>

            <!-- Tags -->
            <StackPanel Spacing="8" IsVisible="{Binding Tags.Count, Converter={StaticResource GreaterThanZeroConverter}, FallbackValue=False}">
              <TextBlock Text="TAGS" 
                         FontSize="11" 
                         FontWeight="Black" 
                         Opacity="0.5" 
                         LetterSpacing="1"/>
              <ItemsControl ItemsSource="{Binding Tags}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="{DynamicResource SystemAccentBrushLight}"
                            BorderBrush="{DynamicResource SystemAccentBrush}"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="8,4"
                            Margin="0,0,6,6">
                      <TextBlock Text="{Binding}" 
                                 FontSize="11" 
                                 FontWeight="Medium"
                                 Foreground="{DynamicResource SystemAccentBrush}"/>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>

          </StackPanel>
        </ScrollViewer>
      </Grid>
    </Panel>
  </Panel>
</UserControl>